# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Project Does
Automates counting of fluorescent worms from RGB TIFF images generated by WormScan. Replaces manual counting in Fiji.

The scanner captures two images of each plate (beginning and end of scan). One appears in the green channel, one in the red channel. Both show the same worms. We count worms in each channel separately and average the two counts for a more accurate result.

## How to Run
```bash
pip install -r requirements.txt
python worm_counter.py              # reads from scan/, writes results.csv + output/
python worm_counter.py --min-size 30 --max-size 8000 --scan-dir my_images/ --output-dir results/
```

## Architecture

Single-file pipeline in `worm_counter.py` with this processing flow:

1. **`find_plate_mask(image)`** — Detects the circular petri plate via Hough circle transform; returns a binary mask to exclude the black background. Falls back to full image if no circle is found.

2. **`count_worms_in_channel(channel, plate_mask, min_size, max_size)`** — Core detection: applies plate mask, Gaussian blur, Otsu threshold, morphological open/close cleanup, then finds and filters contours by area. Returns `(count, contours)`.

3. **`process_image(filepath, min_size, max_size)`** — Splits BGR image into channels (OpenCV BGR order: `b, g, r = cv2.split(image)`), runs `count_worms_in_channel` on G and R channels separately, builds an annotated debug image with colored contour outlines and count text overlay.

4. **`main()`** — CLI entry point. Globs `*.tif` from scan dir, processes each image, writes results to `results.csv`, saves annotated debug images in per-plate subdirectories.

## Key Domain Details
- Input: RGB TIFFs named `RGBImage_Plate_XXTIFF.tif`
- R channel = worms from one scan pass, G channel = worms from the other scan pass
- Yellow in composite = R+G overlap (same worms visible in both passes)
- Output shows green count, red count, and average (red + green) / 2
- OpenCV reads in BGR order, so channel split is `b, g, r`
- Size filtering (`--min-size`/`--max-size`) controls the contour area range accepted as a valid worm
